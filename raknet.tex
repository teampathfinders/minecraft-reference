\chapter{Raknet}\label{chap:raknet}

Instead of TCP, which Java Edition uses, Bedrock uses the UDP protocol.
Unlike TCP, UDP does not provide any reliability or ordering guarantees:
packets may arrive in the wrong order, or not at all. 
To solve these issues, Bedrock uses the Raknet protocol. 
Raknet is a protocol that provides these guarantees on top of UDP.
The advantage of this is that, unlike with TCP, certain guarantees can be disabled if unnecessary,
reducing overhead. Sign is not known in most cases, use what is most logical.

Full documentation for this protocol is available at \url{http://jenkinssoftware.com}.
Its source is available at \url{https://github.com/facebookarchive/raknet}.

\section{Special data types}\label{sec:raknet-types}

Data types used throughout the Raknet protocol are listed below:
\begin{enumerate}
    \item \textit{String} - A string is prefixed with an uint16 specifying its length.
    The string payload immediately follows these uint8s.

    \item \textit{Magic} - The magic (or offline message data) is a sequence of uint8s unique to Raknet that identifies its packets.
    It is equal to \\
    \texttt{0x00ffff00fefefefefdfdfdfd12345678}.

    \item \textit{Address} - Either an IPv4 or IPv6 address.
        The address is prefixed with a single uint8 specifying whether the address is IPv4 (0x04) or IPv6 (0x06).
        In case of an IPv4 address, this prefix is followed by four uint8s for the IP's four octets.
        After which the port is encoded in an uint16. 

        In other words: \\
        \texttt{0x04(1);octets(4);port(2);}

        An IPv6 address starts with an uint16 for the IP family (AF\_INET6). 
        This is then directly followed by another uint16 for the port. 
        Then four uint8s of flow information, and 16 uint8s for the octets.
        Lastly, there are four uint8s specifying scope information.

        The IP family must always equal AF\_INET (0x17), the flow and scope information can be set to 0.
        An IPv6 address is then encoded like this:\\
        \texttt{0x06(1);0x17(2);port(2);0x00(4);octets(16);0x00(4);}
\end{enumerate}

\section{Frames}\label{sec:frames}

Virtually all packets sent using the Raknet protocol will be encapsulated in a frame batch.
These frames allow Raknet to provide the reliability guarantees it does.

\packet{frame-batch}{Frame Batch (0x80..0x8d)}{
    Sequence number & uint24le & Increased for each frame batch sent. The client and server use separate counters. \\
    \hline
    Frames & frame array & This array is not prefixed with a length. The server should continue decoding frames until the buffer is empty. \\
}

\packet{frame}{Frame}{
    Flags & uint8 & Bit flags, with first three bits indicating reliability and the fourth bit determining whether the packet is fragmented. \\ 
    \hline
    Length & uint16 & Length of the frame in bits. \\
    \hline
    Reliable index & uint24le & Reliability index. Only exists when reliable. \\
    \hline 
    Sequence index & uint24le & Sequence index. Only exists if sequenced. \\
    \hline
    Order index & uint24le & Order index. Only exists if ordered. \\
    \hline
    Order channel & uint8 & Order channel. Only exists if ordered. \\
    \hline
    Compound size & uint32 & Fragment count. Only if fragmented. \\
    \hline
    Compound ID & uint16 & Fragment compound ID. Only if fragmented. \\
    \hline
    Compound index & uint32 & Index of this fragment in the compound. Only if fragmented. \\
    \hline
    Body & length/8 bytes & \\
}

\section{Packets}\label{sec:raknet-packets}

\subsection{Unconnected Ping}\label{subsec:unconnected-ping}

About every second, the client refreshes its server list.
This means that the client sends an unconnected ping to each of the servers saved in the list.
This packet has the following format:

\packet{unconnected-ping}{Unconnected Ping (0x01)}{
    Timestamp & uint64 & Timestamp of when this ping was sent. \\
    \hline
    Magic & 16 uint8s & Raknet offline message data. \\
    \hline
    Client GUID & uint64 & Randomised client GUID. \\
}

\textit{Client GUID} - The client GUID field is randomly generated by the client for each connection.
It is not controlled by the server and therefore, generally should not be used by the server to identify clients.
If Xbox authentication is required on the server, it is recommended to use the XUIDs instead.
These XUIDs are guaranteed to be unique and are signed by Mojang to prevent tampering.

\subsection{Unconnected Pong}\label{subsec:unconnected-pong}

An unconnected pong packet should be sent in response to the previously mentioned unconnected ping (paragraph \ref{subsec:unconnected-ping}).
This packet contains the data to be displayed in the server menu.

\packet{unconnected-pong}{Unconnected Pong (0x1c)}{
    Timestamp & uint64 & Timestamp of when this pong was sent. \\
    \hline
    Server GUID & uint64 & Randomly generated server GUID. More info below. \\
    \hline
    Magic & 16 uint8s & Raknet offline message data. \\
    \hline
    Metadata & string & Contains the data to be displayed in the server menu. More info below. \\ 
}

\textit{Server GUID} - It is sufficient to generate a random uint64 at startup, as uint64 as it stays the same between packets.
This GUID is only temporarily used by Raknet during the login sequence, it is not of any significance in the Minecraft protocol.

\textit{Metadata} - The metadata field contains all the data to be displayed by the client.
It consists of data such as the server descripton and player count.
This metadata string has a special, shown below:

\texttt{MCPE;Server Description;Protocol Version;Version Name;Player Count;Max Player Count;Server Name;Game Mode;Game Mode (numeric);Port (IPv4);Port (IPv6)}

The server name field will only be shown for LAN games.
Servers have their name set to whatever the user originally set it as while adding the server to the list.

\subsection{Open Connection Request 1}\label{subsec:open-connection-request1}

An open connection request 1 packet is sent by the client to start connecting to a server.
This is the first packet that is sent when the client joins the server.

\packet{open-connection-request1}{Open Connection Request 1 (0x05)}{
    Magic & 16 uint8s & Raknet offline message data. \\
    \hline
    Protocol version & uint64 & Currently 11. \\
    \hline
    MTU & padding & The MTU (Maximum Transfer Unit). More info below. \\
}

\textit{Protocol version} - This is the version of Raknet that the client is using.
If this version does not match your own, send an incompatible protocol packet in return
(\ref{subsec:incompatible-protocol}). 

\textit{MTU} - The MTU is the maximum size a packet can be before any router auint64 the network
starts dropping packets. It is the maximum size of a packet that Raknet will generate.
This MTU can be calculated by adding 28 to size of this packet. This is to account for overhead of the UDP header.

The client will continuously send copies of this packet with a decreasing padding size.
You should respond to the first of these packets that is received and send the MTU back in the reply packet.

\subsection{Incompatible Protocol}\label{subsec:incompatible-protocol}

Sent in response to an open connection request 1 (\ref{subsec:open-connection-request1}) packet if the Raknet versions do not match.
This will cause the client to disconnect, saying either the client or server is outdated.

\packet{incompatible-protocol}{Incompatible Protocol (0x19)}{
    Protocol & uint8 & Protocol version used by the server. \\
    \hline
    Magic & 16 uint8s & Raknet offline message data \\
    \hline
    Server GUID & uint64 & \\
}

\subsection{Open Connection Reply 1}\label{subsec:open-connection-reply1}

Sent by the server, in response to open connection request, if the Raknet protocol matches.

\packet{open-connection-reply1}{Open Connection Reply 1 (0x06)}{
    Magic & 16 uint8s & \\
    \hline
    Server GUID & uint64 & \\
    \hline
    Security enabled & boolean & Unknown what this does, it must be disabled to continue connecting. \\
    \hline
    MTU & uint16 & MTU determined using the request packet (\ref{subsec:open-connection-request1}). \\
}

\subsection{Open Connection Request 2}

Sent by the client, in response to open connection reply 1.

\packet{open-connection-request2}{Open Connection Request 2 (0x07)}{
    Magic & 16 uint8s & \\
    \hline
    Server address & address & \\
    \hline
    MTU & uint16 & MTU previously sent in open connection reply 1 (\ref{subsec:open-connection-reply1}). \\
    \hline
    Client GUID & uint64 & \\
}

\subsection{Open Connection Reply 2}

Sent by the server, in response to open connection request 2.

\packet{open-connection-reply2}{Open Connection Reply 2 (0x08)}{
    Magic & 16 uint8s & \\
    \hline
    Server GUID & uint64 &  \\
    \hline
    Client address & address & The client's IP address \\
    \hline
    MTU & uint16 & \\
    \hline
    Encryption enabled & boolean & \\
}

\subsection{Connection Request}

Sent by the client, in response to open connection reply 2.
Ideally, the user's server-side session should be created at this point.
Packets received after this are encapsulated in a frame batch, this requires keeping track of session-specific data.

\packet{connection-request}{Connection Request (0x09)}{
    Client GUID & uint64 & \\
    \hline
    Timestamp & uint64 & \\ 
}

\subsection{Connection Request Accepted}

Sent by the server, in response to a connection request packet.

\packet{connection-request-accepted}{Connection Request Accepted (0x10)}{
    Client address & address & \\
    \hline
    System index & uint16 & Unknown what this does. 0 works as a value. \\
    \hline
    Internal IDs & 10x address & Unknown what these do. 255.255.255.255:19132 works as a value. \\
    \hline
    Request timestamp & uint64 & Timestamp from the connection request. \\ 
    \hline
    Timestamp & uint64 & Current time. \\
}

\subsection{New Incoming Connection}

The server does not have to respond to this packet.
All packets sent after this beuint64 to the Bedrock protocol
(except connected pings).

\packet{new-incoming-connection}{New Incoming Connection (0x13)}{
    Server address & address & \\
    \hline
    Internal address & address & Unknown what this does. \\
}

\subsection{Disconnect}

Sent by the client to disconnect from the server.

\packet{disconnect}{Disconnect (0x15)}{
    This packet has no data. \\
}

This packet is sent using a reliable ordered reliability
and should therefore be acknowledged. 
After this packet, the client stops sending to the server and the session can be closed.

